<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<PropertyGroup>
		<MSBuildCommunityTasksPath>$(MSBuildProjectDirectory)\tools\MSBuildCommunity</MSBuildCommunityTasksPath>
		<ExtensionTasksPath>.\</ExtensionTasksPath>
		<InstallDir Condition="$(InstallDir) == ''">\\Wpgbuild01\displacement\NightlyBuild</InstallDir>
	</PropertyGroup>
	
	<Import Project="$(MSBuildProjectDirectory)\tools\MSBuildCommunity\MSBuild.Community.Tasks.Targets"/>
	<Import Project="$(MSBuildProjectDirectory)\tools\ExtensionPack\MSBuild.ExtensionPack.tasks"/>
  
	<Target Name="Deploy">
		<CallTarget Targets="UpdateAssemblyVersion;Build;Publish"/>
	</Target>
	
	<Target Name="DeployBranch">
		<CallTarget Targets="Build;PublishBranch"/>
	</Target>
	
	<Target Name="DeployInstaller">
		<CallTarget Targets="Installer"/>
		<SvnVersion LocalPath="$(MSBuildProjectDirectory)" ToolPath="tools\svn">
		  <Output TaskParameter="Revision" PropertyName="Revision" />
		</SvnVersion>
		<PropertyGroup>
		  <Version>$(Major).$(Minor).$(Build).$(Revision)</Version>
		</PropertyGroup>
		<ItemGroup>
		  <PublishFiles Include="Setup\Price.Displacement.Installer\bin\$(Configuration)\*.msi"/>
		</ItemGroup>
		<Message Text="We are going to publish from %(PublishFiles.RelativeDir)"/>
		<Copy SourceFiles="@(PublishFiles)" 
			  DestinationFiles="$(InstallDir)\PriceDisplacementInstaller_$(Version)_x$(TargetPlatform).msi"/>	
	</Target>
	
	<Target Name="Installer">
		<ItemGroup>
			<Projects Include="$(MSBuildProjectDirectory)\Setup\**\*.wixproj"/>
		</ItemGroup>
		<SvnVersion LocalPath="$(MSBuildProjectDirectory)" ToolPath="tools\svn">
		  <Output TaskParameter="Revision" PropertyName="Revision" />
		</SvnVersion>
		<PropertyGroup>
		  <Version>$(Major).$(Minor).$(Build).$(Revision)</Version>
		</PropertyGroup>
		<MSBuild Projects="@(Projects)" 
				 Properties="Configuration=$(Configuration);WixExtension=WixUIExtension.dll;Version=$(Version);HarvestDir=$(MSBuildProjectDirectory)\main\Price.Displacement.Desktop\bin\$(Configuration)"/>
	</Target>
	
	<Target Name="UpdateAssemblyVersion">
		<SvnVersion LocalPath="$(MSBuildProjectDirectory)" ToolPath="tools\svn">
		  <Output TaskParameter="Revision" PropertyName="Revision" />
		</SvnVersion>

		<ItemGroup>
		  <AssemblyFiles Include="main\**\AssemblyInfo.cs"/>
		</ItemGroup>

		<Message Text="Version: $(Major).$(Minor).$(Build).$(Revision)"/>

		<FileUpdate Files="@(AssemblyFiles)"
					Regex="(\d+)\.(\d+)\.(\d+)\.(\d+)"
					ReplacementText="$(Major).$(Minor).$(Build).$(Revision)" />
	</Target>

    <Target Name="RevertAssemblyVersion">
		<ItemGroup>
		  <AssemblyFiles Include=".\**\AssemblyInfo.cs"/>
		</ItemGroup>
		<Message Text="Revert AssemblyInfo.cs changes"/>
		<Exec Command="tools\svn\svn revert . -R"/>
	</Target>
  
	<Target Name="Publish">
		<SvnVersion LocalPath="$(MSBuildProjectDirectory)" ToolPath="tools\svn">
		  <Output TaskParameter="Revision" PropertyName="Revision" />
		</SvnVersion>
		<PropertyGroup>
		  <InstallDir>\\Wpgbuild01\displacement\NightlyBuild</InstallDir>
		</PropertyGroup>
		<ItemGroup>
		  <PublishFiles Include="main\Price.Displacement.Desktop\bin\$(Configuration)\**\*.*"/>
		</ItemGroup>
		<Message Text="We are going to publish from %(PublishFiles.RelativeDir)"/>
		<Copy SourceFiles="@(PublishFiles)" 
			  DestinationFolder="$(InstallDir)\Displacement_$(Major).$(Minor).$(Build).$(Revision)\%(RecursiveDir)"/>
	</Target>
	
	<Target Name="PublishBranch">
		<SvnVersion LocalPath="$(MSBuildProjectDirectory)" ToolPath="tools\svn">
		  <Output TaskParameter="Revision" PropertyName="Revision" />
		</SvnVersion>
		<Time Format="yyyy_MM_dd_hh_mm"> 
			<Output TaskParameter="FormattedTime" PropertyName="buildDate" /> 
		</Time> 
		<PropertyGroup>
		  <BranchName>feature_products_in_tree_view_1887</BranchName>
		  <InstallDir>\\Wpgbuild01\displacement\Branches\$(BranchName)</InstallDir>
		</PropertyGroup>
		<ItemGroup>
		  <PublishFiles Include="main\Price.Displacement.Desktop\bin\$(Configuration)\**\*.*"/>
		</ItemGroup>
		<Message Text="We are going to publish from %(PublishFiles.RelativeDir)"/>
		<Copy SourceFiles="@(PublishFiles)" 
			  DestinationFolder="$(InstallDir)\Displacement_$(Major).$(Minor).$(Build).$(buildDate)\%(RecursiveDir)"/>
	</Target>
</Project>