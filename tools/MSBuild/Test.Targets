<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<UsingTask TaskName="Gallio.MSBuildTasks.Gallio" AssemblyFile="$(MSBuildProjectDirectory)\tools\Gallio\bin\Gallio.MSBuildTasks.dll"/>
  
	<Target Name="Test">
		<ItemGroup>
			<TestAssemblies Include="test\**\bin\$(Configuration)\*.Tests.dll" 
							Exclude="test\**\*.Acceptance.Tests.dll;test\**\*.Integration.Tests.dll;test\**\*.Specflow.Tests.dll;"
							Condition="$(Testee) == ''"/>
			<TestAssemblies Include="test\*$(Testee).Tests\**\bin\$(Configuration)\*$(Testee).Tests.dll" Condition="$(Testee) != ''"/>
		</ItemGroup>
		<RemoveDuplicates
            Inputs="@(TestAssemblies)">
            <Output
                TaskParameter="Filtered"
                ItemName="FilteredItems"/>
        </RemoveDuplicates>
		<Message Text="The testee found is @(TestAssemblies)" Condition="$(Testee) != ''"/>
		<Message Text="Testing @(FilteredItems)"/>
		<PropertyGroup>
		  <GallioFiles>@(TestAssemblies)</GallioFiles>
		</PropertyGroup>
		<Gallio IgnoreFailures="true" Files="$(GallioFiles)">
		  <Output TaskParameter="ExitCode" PropertyName="ExitCode"/>
		</Gallio>
		<Error Text="Tests execution failed" Condition="'$(ExitCode)' == 1" />
	</Target>

  <Target Name="TestClass">
    <ItemGroup>
      <TestAssemblies Include="test\**\bin\$(Configuration)\*.Tests.dll"
					  Exclude="test\**\*.Acceptance.Tests.dll;test\**\*.Integration.Tests.dll"/>
    </ItemGroup>
    <PropertyGroup>
      <GallioFiles>@(TestAssemblies)</GallioFiles>
    </PropertyGroup>
    <Gallio IgnoreFailures="true" Files="$(GallioFiles)" 
			ReportTypes="Text" ReportNameFormat="mbunit"
            Filter="Type:$(Testee)" Verbosity="Quiet">
      <Output TaskParameter="ExitCode" PropertyName="ExitCode"/>
    </Gallio>
    <Exec Command="%COMSPEC% /c start notepad++ mbunit.txt" ContinueOnError="true"
          WorkingDirectory="reports" Condition="'$(ExitCode)' == 1">
          <Output TaskParameter="ExitCode" PropertyName="ExitCode"/>
    </Exec>
	<Error Text="Tests execution failed" Condition="'$(ExitCode)' == 1" />
  </Target>
</Project>